<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Operator Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-slate-100">

<!-- ================= LOGIN ================= -->
<div id="loginPage" class="min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold text-center mb-6">Login</h2>

    <select id="role" class="w-full p-3 border rounded mb-4">
      <option value="">Select Role</option>
      <option value="operator">Operator</option>
      <option value="admin">Admin</option>
    </select>

    <input id="username" class="w-full p-3 border rounded mb-4" placeholder="Username">
    <input id="password" type="password" class="w-full p-3 border rounded mb-6" placeholder="Password">

    <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded font-semibold">
      Login
    </button>

    <p id="error" class="hidden text-center text-red-600 mt-3 font-semibold">
      Invalid login details
    </p>
  </div>
</div>

<!-- ================= OPERATOR ================= -->
<div id="operatorDash" class="hidden p-6">
  <h1 class="text-2xl font-bold mb-2">Operator Dashboard</h1>
  <p class="mb-4">Logged in as: <b id="opName"></b></p>

  <div class="bg-white p-6 rounded shadow max-w-md">
    <input type="file" id="fileInput" accept=".xlsx,.csv" class="mb-4">
    <button onclick="uploadFile()" class="w-full bg-green-600 text-white py-2 rounded">
      Upload Excel / CSV
    </button>
    <p id="uploadMsg" class="hidden mt-3 text-green-600 font-semibold">
      ✔ File uploaded successfully
    </p>
  </div>

  <button onclick="logout()" class="mt-6 text-red-600">Logout</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminDash" class="hidden p-6">
  <h1 class="text-2xl font-bold mb-4">Admin Dashboard</h1>

  <div class="flex flex-wrap gap-4 mb-6">
    <select id="operatorFilter" onchange="renderCards()" class="p-2 border rounded">
      <option value="all">All Operators</option>
    </select>

    <select id="typeFilter" onchange="renderCards()" class="p-2 border rounded">
      <option value="all">All TYPE</option>
      <option value="U">TYPE (U)</option>
      <option value="N">TYPE (N)</option>
    </select>

    <button id="downloadBtn" onclick="downloadExcel()"
      class="px-4 py-2 bg-indigo-600 text-white rounded disabled:opacity-40"
      disabled>
      Download Uploaded Excel
    </button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-5">

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">Total Records</p>
      <p id="totalRecords" class="text-3xl font-bold">0</p>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">Biometric Update (YES)</p>
      <p id="bioYes" class="text-3xl font-bold text-green-600">0</p>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">Biometric Update (NO)</p>
      <p id="bioNo" class="text-3xl font-bold text-red-600">0</p>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">TYPE (U)</p>
      <p id="typeU" class="text-3xl font-bold text-blue-600">0</p>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">TYPE (N)</p>
      <p id="typeN" class="text-3xl font-bold text-purple-600">0</p>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">Total Amount Charged</p>
      <p id="totalAmount" class="text-3xl font-bold text-green-700">₹0.00</p>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">New Enrollment Amount</p>
      <p id="newEnroll" class="text-3xl font-bold text-blue-600">₹0.00</p>
    </div>

    <div class="bg-white p-5 rounded-xl shadow">
      <p class="text-gray-500 text-sm">Last Upload</p>
      <p id="lastUpload" class="text-lg font-semibold">--</p>
    </div>

  </div>

  <button onclick="logout()" class="mt-6 text-red-600">Logout</button>
</div>

<!-- ================= SCRIPT ================= -->
<script>
let currentOperator = "";

const operatorUsers = {
  "operator1": "1234",
  "operator2": "1234"
};

function login() {
  error.classList.add("hidden");

  const r = role.value;
  const u = username.value.trim().toLowerCase();
  const p = password.value.trim();

  if (!r || !u || !p) {
    error.classList.remove("hidden");
    return;
  }

  if (r === "operator") {
    if (operatorUsers[u] && operatorUsers[u] === p) {
      currentOperator = u;
      opName.innerText = u;
      loginPage.classList.add("hidden");
      operatorDash.classList.remove("hidden");
      return;
    }
  }

  if (r === "admin") {
    if (u === "admin" && p === "admin123") {
      loginPage.classList.add("hidden");
      adminDash.classList.remove("hidden");
      loadAdmin();
      return;
    }
  }

  error.classList.remove("hidden");
}

function logout() {
  location.reload();
}

/* ---------- Upload ---------- */
function uploadFile() {
  const file = fileInput.files[0];
  if (!file) return alert("Please select a file");

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "binary" });
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

    const all = JSON.parse(localStorage.getItem("multiData") || "{}");
    all[currentOperator] = {
      rows,
      time: new Date().toLocaleString(),
      fileName: file.name,
      fileData: e.target.result
    };

    localStorage.setItem("multiData", JSON.stringify(all));
    uploadMsg.classList.remove("hidden");
  };
  reader.readAsBinaryString(file);
}

/* ---------- Admin ---------- */
function loadAdmin() {
  const data = JSON.parse(localStorage.getItem("multiData") || "{}");
  operatorFilter.innerHTML = `<option value="all">All Operators</option>`;
  Object.keys(data).forEach(op => {
    operatorFilter.innerHTML += `<option value="${op}">${op}</option>`;
  });
  renderCards();
}

function normalizeType(v) {
  return String(v || "").trim().toUpperCase();
}
function normalizeBio(v) {
  const x = String(v || "").trim().toUpperCase();
  return ["YES", "Y", "1", "TRUE"].includes(x);
}

function renderCards() {
  const data = JSON.parse(localStorage.getItem("multiData") || {});
  const op = operatorFilter.value;
  const typeSel = typeFilter.value;

  let rows = [];
  let time = "--";

  if (op === "all") {
    Object.values(data).forEach(d => rows.push(...d.rows));
    downloadBtn.disabled = true;
  } else if (data[op]) {
    rows = data[op].rows;
    time = data[op].time;
    downloadBtn.disabled = false;
  }

  if (typeSel !== "all") {
    rows = rows.filter(r => normalizeType(r.TYPE) === typeSel);
  }

  let yes = 0, no = 0, u = 0, n = 0, total = 0, newAmt = 0;

  rows.forEach(r => {
    const t = normalizeType(r.TYPE);
    normalizeBio(r.MANDATORY_BIO_METRIC_UPLOAD_ONLY) ? yes++ : no++;
    if (t === "U") u++;
    if (t === "N") n++;
    total += Number(r.TOTAL_AMOUNT_CHARGED || 0);
    newAmt += Number(r.AMOUNT_CHARGED_FOR_NEW_ENROLLMENT || 0);
  });

  totalRecords.innerText = rows.length;
  bioYes.innerText = yes;
  bioNo.innerText = no;
  typeU.innerText = u;
  typeN.innerText = n;
  totalAmount.innerText = "₹" + total.toFixed(2);
  newEnroll.innerText = "₹" + newAmt.toFixed(2);
  lastUpload.innerText = time;
}

function downloadExcel() {
  const op = operatorFilter.value;
  const data = JSON.parse(localStorage.getItem("multiData") || {});
  if (!data[op]) return;

  const a = document.createElement("a");
  a.href = "data:application/octet-stream;base64," + btoa(data[op].fileData);
  a.download = data[op].fileName;
  a.click();
}
</script>

</body>
</html>
